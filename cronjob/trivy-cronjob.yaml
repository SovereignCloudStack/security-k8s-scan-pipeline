apiVersion: batch/v1
kind: CronJob
metadata:
  name: trivy-reports-cronjob
spec:
  schedule: "0 * * * *" # Every hour
  jobTemplate:
    spec:
      template:
        spec:
          initContainers:
            - name: "vault-agent-init"
              args:
                - touch /home/vault/.vault-token && bao agent -config=/vault/configs/config-zuul-backup.hcl -exit-after-auth=true
              command:
                - "/bin/sh"
                - "-ec"
              env:
                - name: "VAULT_ADDR"
                  value: "https://vault.infra.sovereignit.cloud:8200"
                - name: "VAULT_LOG_LEVEL"
                  value: "debug"
                - name: "VAULT_LOG_FORMAT"
                  value: "standard"
              image: "hashicorp/vault"
              securityContext:
                allowPrivilegeEscalation: false
                capabilities:
                  drop:
                    - ALL
                readOnlyRootFilesystem: true
                runAsGroup: 10001
                runAsNonRoot: true
                runAsUser: 10001
              resources:
                limits:
                  memory: "256Mi"
                requests:
                  cpu: "5m"
                  memory: "32Mi"
              volumeMounts:
                - mountPath: "/home/vault"
                  name: "home-init"
                - mountPath: "/var/run/secrets/kubernetes.io/serviceaccount"
                  name: "kube-api-access"
                  readOnly: true
                - mountPath: "/vault/secrets"
                  name: "cron-config"
                - mountPath: "/vault/configs"
                  name: "vault-config"
                  readOnly: true
          containers:
          - name: trivy-reports-getter
            image: bitnami/kubectl
            command: ["/bin/sh", "-c", " ./scripts/getter.sh && touch /tmp/report_done"]
            volumeMounts:
            - name: scripts
              mountPath: /scripts
            - mountPath: "/etc/openstack"
              name: "cron-config"
              subPath: "openstack"
            - mountPath: "/tmp/reports"
              name: "reports"
          - name: trivy-reports-uploader
            image: openstacktools/openstack-client
            command: ["/bin/sh", "-c", "while [ ! -f /tmp/report_done ]; do sleep 1; done; python3 /scripts/reporter.py"]
            volumeMounts:
            - name: scripts
              mountPath: /scripts
            - mountPath: "/etc/openstack"
              name: "cron-config"
              subPath: "openstack"
            - mountPath: "/tmp/reports"
              name: "reports"

          restartPolicy: OnFailure

          
          volumes:
          - name: scripts
            configMap:
              name: trivy-reports-scripts-configmap
          - name: "cron-config"
            emptyDir:
              medium: "Memory"
          - name: "reports"
            emptyDir:
              medium: "Memory"
          - name: "kube-api-access"
            projected:
              defaultMode: 420
              sources:
                - serviceAccountToken:
                    expirationSeconds: 7200
                    path: "token"
                - configMap:
                    items:
                      - key: "ca.crt"
                        path: "ca.crt"
                    name: "kube-root-ca.crt"
                - downwardAPI:
                    items:
                      - fieldRef:
                          apiVersion: "v1"
                          fieldPath: "metadata.namespace"
                        path: "namespace"
          - name: "home-init"
            emptyDir:
              medium: "Memory"
          - name: "vault-config"
            configMap:
              name: "vault-agent-config"